---

- name: Run install tasks
  include_tasks: "{{ loop_main_ansible_pull }}"
  with_first_found:
    - "{{ ansible_distribution_release | lower }}.yml"
    - "{{ ansible_distribution | lower }}-{{ ansible_distribution_version | lower }}.yml"
    - "{{ ansible_distribution | lower }}-{{ ansible_distribution_major_version | lower }}.yml"
    - "{{ ansible_os_family | lower }}-{{ ansible_distribution_major_version | lower }}.yml"
    - "{{ ansible_distribution | lower }}.yml"
    - "{{ ansible_os_family | lower }}.yml"
  loop_control:
    loop_var: loop_main_ansible_pull

- name: Create a directory if it does not exist
  file:
    path: /etc/ansible
    state: directory
    group: root
    owner: root
    mode: 0644
  become: true

- name: Copy Ansible config
  template:
    src: ansible.cfg.j2
    dest: /etc/ansible/ansible.cfg
    group: root
    owner: root
    mode: 0644
  become: true


- name: Cronjob Entry from Public Repo
  cron:
    name: "Ansible-Pull from Public Repo"
    minute: "*/{{ cron_intervals }}"
    hour: "*"
    day: "*"
    month: "*"
    weekday: "*"
    job: "ansible-pull --only-if-changed --sleep 15 -U https://{{ project_link }} -i {{ inventory }} {{ playbook }} --limit 127.0.0.1 --vault-password-file=/home/{{ user.name }}/.random"
    user: root
    cron_file: ansible_pull # creates a file under /etc/cron.d

- name: Enable cronie Service
  systemd:
    name: cronie.service
    state: started
    enabled: yes
